@model dynamic

@{
    ViewData["Title"] = "Manuel Tahmin";
}

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

<style>
    #map {
        width: 100%;
        height: 500px; /* Harita yüksekliği arttırıldı */
        margin-bottom: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        z-index: 1;
        background-color: #f8f9fa; /* Harita yüklenmeden önceki arka plan */
    }
    .loading-overlay {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(255,255,255,0.8);
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        font-weight: bold;
        border-radius: 8px;
    }
    .weather-info-box {
        display: none; /* JS ile açılacak */
        margin-top: 15px;
        padding: 15px;
        border-radius: 8px;
        background-color: #e3f2fd;
        border: 1px solid #90caf9;
        color: #0d47a1;
    }
</style>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white d-flex align-items-center">
                    <h4 class="mb-0"><i class="fa-solid fa-map-location-dot me-2"></i>Konum ve Hava Durumu Seçimi</h4>
                </div>
                <div class="card-body position-relative">
                    
                    <!-- Yükleniyor Ekranı -->
                    <div id="loading" class="loading-overlay">
                        <div class="spinner-border text-primary mb-2" style="width: 3rem; height: 3rem;" role="status">
                            <span class="visually-hidden">Yükleniyor...</span>
                        </div>
                        <span class="fs-5">Şehir ve hava durumu bilgisi alınıyor...</span>
                    </div>
                    
                    <div class="alert alert-info py-2 small">
                        <i class="fa-solid fa-info-circle me-1"></i>Harita üzerinde bir konuma tıklayarak şehir ve hava durumu bilgisini otomatik alabilirsiniz.
                    </div>
                    
                    <!-- Harita Alanı -->
                    <div id="map"></div>

                    <!-- Anlık Hava Durumu Bilgi Kutusu -->
                    <div id="weatherInfo" class="weather-info-box">
                        <div class="d-flex align-items-center">
                            <i class="fa-solid fa-cloud-sun fa-2x me-3"></i>
                            <div>
                                <h5 class="mb-1" id="weatherCityTitle">Şehir</h5>
                                <p class="mb-0" id="weatherDetails">Sıcaklık: <strong>-- °C</strong> | Rüzgar: <strong>-- km/s</strong></p>
                            </div>
                        </div>
                    </div>

                    <form action="/Weather/Hesapla" method="post" class="mt-4">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Şehir:</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white"><i class="fa-solid fa-city text-primary"></i></span>
                                    <input type="text" id="sehirInput" name="sehir" class="form-control" placeholder="Haritadan seçin" required />
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Sıcaklık (°C):</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white"><i class="fa-solid fa-temperature-half text-danger"></i></span>
                                    <input type="number" id="sicaklikInput" name="sicaklik" class="form-control" placeholder="Otomatik veya manuel" required step="0.1" />
                                </div>
                            </div>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg shadow-sm">
                                <i class="fa-solid fa-check-circle me-2"></i>Hesapla ve Kaydet
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <script>
        $(document).ready(function () {
            // Türkiye'nin sınırları (Daha sıkı sınırlar)
            var southWest = L.latLng(35.8, 25.5), // Güneybatı (Ege denizi açıkları)
                northEast = L.latLng(42.2, 44.8), // Kuzeydoğu (Gürcistan/Ermenistan sınırı)
                bounds = L.latLngBounds(southWest, northEast);

            // Haritayı başlat
            var map = L.map('map', {
                center: [39.0, 35.2], // Türkiye'nin tam ortası (Kayseri civarı)
                zoom: 6,
                minZoom: 6, // Daha fazla uzaklaşmayı engelle (Sadece Türkiye görünsün)
                maxZoom: 10,
                maxBounds: bounds,
                maxBoundsViscosity: 1.0, // Sınırlara tam yapış
                dragging: true, // Sürüklemeye izin ver ama sınırlar içinde
                bounceAtZoomLimits: false
            });

            // OpenStreetMap katmanını ekle
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            var marker;

            // Haritaya tıklama olayı
            map.on('click', function(e) {
                var lat = e.latlng.lat;
                var lng = e.latlng.lng;

                // Varsa eski markeri kaldır
                if (marker) {
                    map.removeLayer(marker);
                }

                // Yeni marker ekle
                marker = L.marker([lat, lng]).addTo(map);

                // Yükleniyor ekranını göster
                $('#loading').css('display', 'flex');
                $('#weatherInfo').slideUp(); // Eski hava durumu bilgisini gizle

                // 1. ADIM: Şehir İsmini Bul (Nominatim API)
                $.ajax({
                    url: `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10&addressdetails=1`,
                    type: 'GET',
                    headers: { 'Accept-Language': 'tr' },
                    success: function(addressData) {
                        
                        // Şehir ismini ayıkla
                        var city = "Bilinmiyor";
                        if (addressData && addressData.address) {
                            city = addressData.address.province || addressData.address.city || addressData.address.state || addressData.address.town || addressData.address.county || "Bilinmiyor";
                            // Temizlik (İli, Vilayeti vb.)
                            city = city.replace(' İli', '').replace(' Vilayeti', '').replace(' Province', '');
                        }
                        
                        $('#sehirInput').val(city);

                        // 2. ADIM: Hava Durumu Bilgisini Bul (Open-Meteo API - Ücretsiz)
                        $.ajax({
                            url: `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true&windspeed_unit=kmh`,
                            type: 'GET',
                            success: function(weatherData) {
                                $('#loading').hide();

                                if (weatherData && weatherData.current_weather) {
                                    var temp = weatherData.current_weather.temperature;
                                    var wind = weatherData.current_weather.windspeed;
                                    
                                    // Sıcaklık inputunu doldur
                                    $('#sicaklikInput').val(temp);
                                    
                                    // Bilgi kutusunu güncelle ve göster
                                    $('#weatherCityTitle').text(city + " Hava Durumu");
                                    $('#weatherDetails').html(`Sıcaklık: <strong>${temp} °C</strong> | Rüzgar: <strong>${wind} km/s</strong>`);
                                    $('#weatherInfo').slideDown();

                                    // Popup güncelle
                                    marker.bindPopup(`
                                        <div style="text-align:center;">
                                            <strong>${city}</strong><br>
                                            <span style="font-size:14px; color:#d9534f;">${temp} °C</span>
                                        </div>
                                    `).openPopup();
                                }
                            },
                            error: function() {
                                $('#loading').hide();
                                alert('Hava durumu verisi alınamadı.');
                            }
                        });

                    },
                    error: function() {
                        $('#loading').hide();
                        $('#sehirInput').val('Konum Bulunamadı');
                        alert('Konum bilgisi alınamadı.');
                    }
                });
            });
        });
    </script>
}